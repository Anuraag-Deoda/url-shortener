{% extends 'base.html' %}

{% block title %}{{ campaign.name }} - Campaign Analytics{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'shortener:campaign_list' %}">Campaigns</a></li>
            <li class="breadcrumb-item active">{{ campaign.name }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-bullhorn me-2"></i>{{ campaign.name }}</h2>
            {% if campaign.description %}
            <p class="text-muted mb-0">{{ campaign.description }}</p>
            {% endif %}
        </div>
        <div>
            <div class="btn-group me-2">
                <a href="?days=7" class="btn btn-{% if days == 7 %}primary{% else %}outline-primary{% endif %}">7d</a>
                <a href="?days=30" class="btn btn-{% if days == 30 %}primary{% else %}outline-primary{% endif %}">30d</a>
                <a href="?days=90" class="btn btn-{% if days == 90 %}primary{% else %}outline-primary{% endif %}">90d</a>
            </div>
            <a href="{% url 'shortener:campaign_edit' campaign.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-1"></i>Edit
            </a>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card bg-primary text-white shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ performance.total_clicks|default:0 }}</h3>
                    <small>Total Clicks</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ performance.unique_visitors|default:0 }}</h3>
                    <small>Unique Visitors</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ performance.conversions|default:0 }}</h3>
                    <small>Conversions</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-dark shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ performance.conversion_rate|default:0 }}%</h3>
                    <small>Conv. Rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">${{ performance.revenue|floatformat:2 }}</h3>
                    <small>Revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card {% if performance.roi and performance.roi > 0 %}bg-success{% elif performance.roi and performance.roi < 0 %}bg-danger{% else %}bg-secondary{% endif %} text-white shadow">
                <div class="card-body text-center">
                    <h3 class="mb-0">{% if performance.roi is not None %}{{ performance.roi }}%{% else %}N/A{% endif %}</h3>
                    <small>ROI</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Metrics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Cost Per Click (CPC)</h6>
                            <h3 class="mb-0">${{ performance.cpc|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-mouse-pointer fa-2x text-muted"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Cost Per Acquisition (CPA)</h6>
                            <h3 class="mb-0">${{ performance.cpa|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x text-muted"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Budget Status</h6>
                            {% if campaign.budget %}
                            <h3 class="mb-0">${{ campaign.spent }} / ${{ campaign.budget }}</h3>
                            <div class="progress mt-2" style="height: 6px;">
                                {% widthratio campaign.spent campaign.budget 100 as pct %}
                                <div class="progress-bar {% if pct > 90 %}bg-danger{% elif pct > 70 %}bg-warning{% else %}bg-success{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            {% else %}
                            <h3 class="mb-0 text-muted">No Budget Set</h3>
                            {% endif %}
                        </div>
                        <i class="fas fa-wallet fa-2x text-muted"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Daily Trend Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Daily Performance</h5>
                </div>
                <div class="card-body">
                    <div id="daily-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Source Breakdown -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sitemap me-2"></i>Traffic Sources</h5>
                </div>
                <div class="card-body">
                    {% if performance.source_stats %}
                    <ul class="list-group list-group-flush">
                        {% for source in performance.source_stats %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ source.utm_source|default:"(direct)" }}</strong>
                                <br><small class="text-muted">{{ source.visitors }} visitors</small>
                            </span>
                            <span class="badge bg-primary rounded-pill">{{ source.clicks }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center mb-0">No source data</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Medium Breakdown -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Performance by Medium</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Medium</th>
                                    <th class="text-end">Clicks</th>
                                    <th class="text-end">Visitors</th>
                                    <th class="text-end">Conversions</th>
                                    <th class="text-end">Conv. Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medium in performance.medium_stats %}
                                <tr>
                                    <td><strong>{{ medium.utm_medium|default:"(none)" }}</strong></td>
                                    <td class="text-end">{{ medium.clicks }}</td>
                                    <td class="text-end">{{ medium.visitors }}</td>
                                    <td class="text-end">{{ medium.conversions }}</td>
                                    <td class="text-end">
                                        {% if medium.visitors > 0 %}
                                        {% widthratio medium.conversions medium.visitors 100 as rate %}
                                        {{ rate|default:0 }}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign URLs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>Campaign URLs</h5>
                    <a href="{% url 'shortener:campaign_urls' campaign.pk %}" class="btn btn-sm btn-outline-primary">
                        Manage URLs
                    </a>
                </div>
                <div class="card-body">
                    {% if urls %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Short Code</th>
                                    <th>Original URL</th>
                                    <th>UTM Source</th>
                                    <th>UTM Medium</th>
                                    <th>UTM Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cu in urls %}
                                <tr>
                                    <td><code>{{ cu.url.short_code }}</code></td>
                                    <td><small>{{ cu.url.original_url|truncatechars:50 }}</small></td>
                                    <td>{{ cu.utm_source|default:"-" }}</td>
                                    <td>{{ cu.utm_medium|default:"-" }}</td>
                                    <td>{{ cu.utm_content|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">No URLs linked to this campaign</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dailyStats = {{ performance.daily_stats|safe }};

    if (dailyStats && dailyStats.length > 0) {
        const dates = dailyStats.map(d => d.date);
        const clicks = dailyStats.map(d => d.clicks);
        const visitors = dailyStats.map(d => d.visitors);
        const conversions = dailyStats.map(d => d.conversions || 0);

        const data = [
            {
                x: dates,
                y: clicks,
                name: 'Clicks',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#0d6efd' }
            },
            {
                x: dates,
                y: visitors,
                name: 'Visitors',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#198754' }
            },
            {
                x: dates,
                y: conversions,
                name: 'Conversions',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#ffc107' }
            }
        ];

        const layout = {
            margin: { t: 10, r: 20, b: 40, l: 50 },
            xaxis: { title: '' },
            yaxis: { title: '' },
            legend: { orientation: 'h', y: -0.2 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        };

        Plotly.newPlot('daily-chart', data, layout, {responsive: true});
    } else {
        document.getElementById('daily-chart').innerHTML =
            '<p class="text-center text-muted py-5">No daily data available</p>';
    }
});
</script>
{% endblock %}
